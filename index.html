<div>Teachable Machine Image Model</div>
<button type="button" onclick="init()">Start</button>
<div id="webcam-container"></div>
<button type="button" onclick="doPredict()">Predict</button>
<button type="button" onclick="switchCamera()">Switch Camera</button>
<h1 id="class_predicted"></h1>
<div id="label-container"></div>

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest/dist/teachablemachine-image.min.js"></script>
<script type="text/javascript">
    const URL = "https://teachablemachine.withgoogle.com/models/KJlqqZ0Zl/";

    let model, webcam, labelContainer, maxPredictions;

    // Variable to track which camera is active
    let usingFrontCamera = true;

    async function init() {
        const modelURL = URL + "model.json";
        const metadataURL = URL + "metadata.json";

        model = await tmImage.load(modelURL, metadataURL);
        maxPredictions = model.getTotalClasses();

        setupWebcam();

        document.getElementById("webcam-container").appendChild(webcam.canvas);
        labelContainer = document.getElementById("label-container");
        for (let i = 0; i < maxPredictions; i++) {
            labelContainer.appendChild(document.createElement("div"));
        }
    }

    async function setupWebcam() {
        // If webcam is already initialized, stop it
        if (webcam) {
            webcam.stop();
        }

        // Initialize webcam based on active camera
        webcam = new tmImage.Webcam(200, 200, usingFrontCamera);
        await webcam.setup();
        await webcam.play();
        window.requestAnimationFrame(loop);
    }

    async function switchCamera() {
        usingFrontCamera = !usingFrontCamera; // switch the camera
        await setupWebcam();
    }

    async function loop() {
        webcam.update();
        window.requestAnimationFrame(loop);
    }

    async function predict() {
        const prediction = await model.predict(webcam.canvas);
        const classWothMaxProbability = prediction.reduce((prev, current) => (prev.probability > current.probability) ? prev : current);
        document.getElementById("class_predicted").innerHTML = classWothMaxProbability.className;
    }

    async function doPredict() {
        await predict();
    }
</script>
